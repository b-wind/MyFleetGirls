#!/bin/bash

JAVA_HOME=$HOME/etc/soft/jdk1.8.0_45
pid=server/target/universal/stage/RUNNING_PID
port1=9003
port2=9004
NICE=19

if [ `netstat -ant | grep ":$port1" | wc -l` -gt 0 ]
then
    port=$port2
else
    port=$port1
fi

# Directory
myfleet_dir=$HOME/service/MyFleetGirls/$port
cd $myfleet_dir

# Kill old process
kill `cat $pid`

git --git-dir=.git pull
nice -n $NICE sbt -java-home $JAVA_HOME zip
sleep 3
nice -n $NICE /mnt/backup/service/dump/myfleet/dump.sh
nice -n $NICE sbt -java-home $JAVA_HOME stage
JAVA_HOME=$JAVA_HOME server/target/universal/stage/bin/myfleetgirlsserver -J-Xms1G -J-Xmx2G -J-Xloggc:$myfleet_dir/gc.log -J-XX:+HeapDumpOnOutOfMemoryError &

sleep 10
echo "Kill old process"
if [ $port -eq $port1 ]
then
    kill `cat ../$port2/$pid`
else
    kill `cat ../$port1/$pid`
fi
